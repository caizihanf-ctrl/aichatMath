<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math AI Chat (Load & Save)</title>
    
    <!-- Markdown è§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- MathJax å…¬å¼æ¸²æŸ“ -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['[', ']']],
                processEscapes: true
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                typeset: false
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <style>
        :root {
            --bg-color: #f4f4f9;
            --primary-color: #4a90e2;
            --toolbar-bg: #eef2f5;
            --border-color: #d1d5db;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨è®¾ç½®æ  */
        .settings-header {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .settings-panel {
            background: #34495e;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            border-bottom: 1px solid #4a6278;
            flex-shrink: 0;
        }
        
        @media (min-width: 600px) {
            .settings-panel {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }

        .settings-panel.show { display: flex; }

        .settings-panel input[type="text"], 
        .settings-panel input[type="password"] {
            background: #2c3e50;
            border: 1px solid #5dade2;
            color: white;
            padding: 8px;
            border-radius: 4px;
            flex: 1;
            min-width: 120px;
            font-size: 0.9rem;
        }

        /* æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
        .model-selector-group {
            position: relative;
            display: flex;
            flex: 1;
            min-width: 200px;
        }

        .model-selector-group input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }

        .model-list-btn {
            background: #2980b9;
            border: 1px solid #5dade2;
            color: white;
            padding: 0 12px;
            cursor: pointer;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .model-list-btn:hover { background: #3498db; }
        .model-list-btn:active { background: #1f618d; }

        /* æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨ */
        .model-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2c3e50;
            border: 1px solid #5dade2;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-top: 2px;
        }

        .model-dropdown.show { display: block; }

        .model-option {
            padding: 8px 12px;
            color: #ecf0f1;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid #34495e;
        }

        .model-option:last-child { border-bottom: none; }
        .model-option:hover { background: #34495e; color: #5dade2; }
        .model-option.loading { text-align: center; color: #bdc3c7; cursor: default; }
        .model-option.error { color: #e74c3c; font-size: 0.8rem; }

        .model-dropdown::-webkit-scrollbar { width: 6px; }
        .model-dropdown::-webkit-scrollbar-thumb { background: #5dade2; border-radius: 3px; }
        .model-dropdown::-webkit-scrollbar-track { background: #2c3e50; }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .action-btn {
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: center;
        }

        .save-btn { background: #27ae60; }
        .save-btn:hover { background: #2ecc71; }

        .export-btn { background: #e67e22; }
        .export-btn:hover { background: #d35400; }

        .autosave-btn { background: #8e44ad; }
        .autosave-btn:hover { background: #9b59b6; }
        .autosave-btn.active { background: #2ecc71; pointer-events: none; }

        /* æ–°å¢ï¼šåŠ è½½æŒ‰é’®æ ·å¼ */
        .import-btn { background: #16a085; }
        .import-btn:hover { background: #1abc9c; }
        
        .status-indicator {
            font-size: 0.8rem;
            margin-left: 10px;
            color: #bdc3c7;
            display: flex;
            align-items: center;
        }
        .status-indicator.recording { color: #2ecc71; }

        /* èŠå¤©åŒºåŸŸ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            word-wrap: break-word;
            font-size: 0.95rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.ai {
            align-self: flex-start;
            background-color: white;
            color: #333;
            border-bottom-left-radius: 2px;
            border: 1px solid var(--border-color);
        }

        /* åº•éƒ¨åŒºåŸŸå®¹å™¨ */
        .bottom-section {
            background: white;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            position: relative; /* ä¸ºäº†å®šä½é¢„è§ˆåŒº */
        }

        /* å®æ—¶é¢„è§ˆåŒºæ ·å¼ */
        .math-preview-area {
            background: #fffdf5; /* æ·¡æ·¡çš„é»„è‰²èƒŒæ™¯ï¼ŒåŒºåˆ†è¾“å…¥åŒº */
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 15px;
            font-size: 0.9rem;
            color: #555;
            max-height: 120px;
            overflow-y: auto;
            display: none; /* é»˜è®¤éšè— */
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.02);
        }

        .math-preview-area.show {
            display: block;
            animation: fadeIn 0.2s ease-in-out;
        }
        
        .math-preview-area p { margin: 0; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ•°å­¦ç¬¦å·å·¥å…·æ  */
        .math-toolbar-container {
            background-color: var(--toolbar-bg);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .math-toolbar-row {
            display: flex;
            gap: 8px;
            padding: 6px 10px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .math-toolbar-row:first-child {
            border-bottom: 1px solid #e2e8f0;
        }

        .math-toolbar-row::-webkit-scrollbar { display: none; }

        .math-btn {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9rem;
            font-family: Consolas, "Times New Roman", serif;
            cursor: pointer;
            user-select: none;
            color: #334155;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
        }

        .math-btn:active {
            background-color: #e2e8f0;
            transform: translateY(1px);
        }
        
        .math-btn span { pointer-events: none; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            display: flex;
            padding: 10px;
            gap: 10px;
            align-items: flex-end;
            background: white;
        }

        textarea {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
            resize: none;
            height: 44px;
            max-height: 120px;
            outline: none;
            font-family: inherit;
        }

        textarea:focus { border-color: var(--primary-color); }

        button#send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 20px;
            height: 44px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        button#send-btn:disabled { background-color: #94a3b8; }

        .message.ai pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .message.ai p { margin: 0 0 8px 0; }
        .message.ai p:last-child { margin: 0; }
        
        * { touch-action: manipulation; }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨è®¾ç½® (å¯æŠ˜å ) -->
<div class="settings-header" onclick="toggleSettings()">
    <div style="display:flex; align-items:center;">
        <span>âš™ï¸ è®¾ç½®ä¸ API Key</span>
        <span id="autosave-status" class="status-indicator"></span>
    </div>
    <span id="toggle-icon">â–¼</span>
</div>
<div class="settings-panel" id="settings-panel">
    <input type="text" id="api-url" placeholder="API åœ°å€ (å¦‚ https://api.openai.com/v1)">
    <input type="password" id="api-key" placeholder="API Key (sk-...)">
    
    <!-- æ¨¡å‹é€‰æ‹©åŒºåŸŸ -->
    <div class="model-selector-group">
        <input type="text" id="model-name" placeholder="æ¨¡å‹ (å¦‚ gpt-4o, deepseek-chat)">
        <button class="model-list-btn" onclick="fetchAndShowModels(event)" title="è·å–æ¨¡å‹åˆ—è¡¨">â–¼</button>
        <div id="model-dropdown" class="model-dropdown"></div>
    </div>

    <button class="action-btn save-btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
    
    <!-- è‡ªåŠ¨ä¿å­˜æŒ‰é’® -->
    <button id="btn-autosave" class="action-btn autosave-btn" onclick="setupAutoSave()">
        <span>ğŸ“‚</span> å¯ç”¨è‡ªåŠ¨ä¿å­˜
    </button>
    
    <!-- æ–°å¢ï¼šåŠ è½½å¯¹è¯æŒ‰é’® (è§¦å‘éšè—çš„ file input) -->
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleFileImport(this)">
    <button class="action-btn import-btn" onclick="document.getElementById('import-file').click()">
        <span>ğŸ“¥</span> åŠ è½½å¯¹è¯
    </button>

    <button class="action-btn export-btn" onclick="exportChat()">å¯¼å‡ºå¯¹è¯</button>
</div>

<!-- èŠå¤©å†…å®¹ -->
<div id="chat-container">
    <div class="message ai">
        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ•°å­¦åŠ©æ‰‹ã€‚
        <br>ç‚¹å‡»ä¸‹æ–¹çš„å·¥å…·æ å¯ä»¥å¿«é€Ÿè¾“å…¥æ•°å­¦ç¬¦å·ï¼Œæˆ‘ä¼šè‡ªåŠ¨æ¸²æŸ“å…¬å¼ã€‚
        <br><b>æç¤ºï¼š</b>ä½ ç°åœ¨å¯ä»¥ç‚¹å‡»è®¾ç½®æ ä¸­çš„â€œåŠ è½½å¯¹è¯â€æ¥æ¢å¤ä¹‹å‰çš„èŠå¤©è®°å½•ã€‚
    </div>
</div>

<!-- åº•éƒ¨åŒºåŸŸï¼šé¢„è§ˆåŒº + å·¥å…·æ  + è¾“å…¥æ¡† -->
<div class="bottom-section">
    <!-- å®æ—¶é¢„è§ˆåŒº -->
    <div id="math-preview" class="math-preview-area"></div>

    <div class="math-toolbar-container">
        <!-- ç¬¬ä¸€è¡Œï¼šåŸºç¡€ç¬¦å· -->
        <div class="math-toolbar-row" id="math-toolbar-basic"></div>
        <!-- ç¬¬äºŒè¡Œï¼šé«˜çº§å‡½æ•° -->
        <div class="math-toolbar-row" id="math-toolbar-funcs"></div>
    </div>

    <div class="input-area">
        <textarea id="user-input" placeholder="è¾“å…¥æ•°å­¦é—®é¢˜..." rows="1"></textarea>
        <button id="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>
</div>

<script>
    // --- 1. æ•°å­¦ç¬¦å·é…ç½® ---
    
    const basicSymbols = [
        { label: '+', insert: '+', offset: 0 },
        { label: '-', insert: '-', offset: 0 },
        { label: '*', insert: '*', offset: 0 },
        { label: '/', insert: '/', offset: 0 },
        { label: '=', insert: '=', offset: 0 },
        { label: '\'', insert: '\'', offset: 0 },
        { label: '%', insert: '%', offset: 0 },
        { label: '(', insert: '(', offset: 0 },
        { label: ')', insert: ')', offset: 0 },
        { label: '^', insert: '^', offset: 0 },
        { label: 'â†’', insert: '\\to ', offset: 0 }
    ];

    const funcSymbols = [
        { label: '$', insert: '$$', offset: 1},
        { label: 'x', insert: 'x', offset: 0},
        { label: 'xÂ²', insert: '^{2}', offset: 0 },
        { label: 'xâ¿', insert: '^{}', offset: 1 },
        { label: 'âˆš', insert: '\\sqrt{}', offset: 1 },
        { label: 'â¿âˆš', insert: '\\sqrt[]{}', offset: 3 },
        { label: 'frac', insert: '\\frac{}{}', offset: 3 },
        { label: 'sin', insert: '\\sin()', offset: 1 },
        { label: 'cos', insert: '\\cos()', offset: 1 },
        { label: 'tan', insert: '\\tan()', offset: 1 },
        { label: 'ln', insert: '\\ln()', offset: 1 },
        { label: 'log', insert: '\\log_{}{}', offset: 3 },
        { label: 'eË£', insert: 'e^{}', offset: 1 },
        { label: 'Ï€', insert: '\\pi', offset: 0 },
        { label: 'Î¸', insert: '\\theta', offset: 0 },
        { label: 'âˆ', insert: '\\infty', offset: 0 },
        { label: 'âˆ«', insert: '\\int ', offset: 0 },
        { label: 'âˆ«ab', insert: '\\int_{}^{}', offset: 3 },
        { label: 'dx', insert: 'dx', offset: 0 },
        { label: 'd/dx', insert: '\\frac{d}{dx}', offset: 0 },
        { label: 'âˆ‚', insert: '\\partial', offset: 0 },
        { label: 'âˆ‘', insert: '\\sum_{}^{}', offset: 3 },
        { label: 'lim', insert: '\\lim_{ \\to }', offset: 4 },
        { label: 'â‰¤', insert: '\\le', offset: 0 },
        { label: 'â‰¥', insert: '\\ge', offset: 0 },
        { label: 'â‰ˆ', insert: '\\approx', offset: 0 },
        { label: 'â‰ ', insert: '\\ne', offset: 0 },
        { label: 'âˆµ', insert: '\\because', offset: 0 },
        { label: 'âˆ´', insert: '\\therefore', offset: 0 }
    ];

    // --- 2. åˆå§‹åŒ–é€»è¾‘ ---
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const previewArea = document.getElementById('math-preview');
    
    function renderToolbar(containerId, symbols) {
        const container = document.getElementById(containerId);
        symbols.forEach(sym => {
            const btn = document.createElement('div');
            btn.className = 'math-btn';
            btn.textContent = sym.label;
            btn.onmousedown = (e) => e.preventDefault(); 
            btn.onclick = () => insertSymbol(sym.insert, sym.offset);
            container.appendChild(btn);
        });
    }

    renderToolbar('math-toolbar-basic', basicSymbols);
    renderToolbar('math-toolbar-funcs', funcSymbols);

    function insertSymbol(text, offsetBack) {
        const start = userInput.selectionStart;
        const end = userInput.selectionEnd;
        const value = userInput.value;
        userInput.value = value.substring(0, start) + text + value.substring(end);
        const newPos = start + text.length - offsetBack;
        userInput.setSelectionRange(newPos, newPos);
        userInput.focus();
        userInput.dispatchEvent(new Event('input')); 
    }

    // --- 3. èŠå¤©ä¸ API é€»è¾‘ ---
    const defaultUrl = "https://api.openai.com/v1";
    const defaultModel = "gpt-3.5-turbo";
    let messageHistory = [];
    
    // --- è‡ªåŠ¨ä¿å­˜ç›¸å…³å˜é‡ ---
    let fileHandle = null;
    let isAutoSaveActive = false;

    window.onload = () => {
        document.getElementById('api-url').value = localStorage.getItem('api_url') || '';
        document.getElementById('api-key').value = localStorage.getItem('api_key') || '';
        document.getElementById('model-name').value = localStorage.getItem('model_name') || defaultModel;
        
        marked.setOptions({
            highlight: (code, lang) => highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value
        });

        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('model-dropdown');
            const btn = document.querySelector('.model-list-btn');
            if (!dropdown.contains(e.target) && e.target !== btn) {
                dropdown.classList.remove('show');
            }
        });
    };

    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        const icon = document.getElementById('toggle-icon');
        if (panel.style.display === 'flex') {
            panel.style.display = 'none';
            icon.textContent = 'â–¼';
        } else {
            panel.style.display = 'flex';
            icon.textContent = 'â–²';
        }
    }

    function saveSettings() {
        localStorage.setItem('api_url', document.getElementById('api-url').value);
        localStorage.setItem('api_key', document.getElementById('api-key').value);
        localStorage.setItem('model_name', document.getElementById('model-name').value);
        alert('é…ç½®å·²ä¿å­˜');
        const panel = document.getElementById('settings-panel');
        if(panel.style.display === 'flex') toggleSettings();
    }

    // --- è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ ---
    async function setupAutoSave() {
        if (!('showDirectoryPicker' in window)) {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—® APIã€‚è¯·ä½¿ç”¨ Chrome/Edge æ¡Œé¢ç‰ˆã€‚');
            return;
        }

        try {
            const dirHandle = await window.showDirectoryPicker();
            const now = new Date();
            const timestamp = now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') + '_' +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0') +
                String(now.getSeconds()).padStart(2, '0');
            const fileName = `chat_${timestamp}.json`;

            fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
            
            isAutoSaveActive = true;
            const btn = document.getElementById('btn-autosave');
            btn.innerHTML = `<span>âœ…</span> ${fileName}`;
            btn.classList.add('active');
            
            const status = document.getElementById('autosave-status');
            status.textContent = "â— æ­£åœ¨è®°å½•";
            status.classList.add('recording');

            await writeToFile();
            alert(`è‡ªåŠ¨ä¿å­˜å·²å¼€å¯ï¼æ–‡ä»¶: ${fileName}`);

        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error(err);
                alert('è®¾ç½®è‡ªåŠ¨ä¿å­˜å¤±è´¥: ' + err.message);
            }
        }
    }

    async function writeToFile() {
        if (!fileHandle || !isAutoSaveActive) return;
        try {
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(messageHistory, null, 2));
            await writable.close();
        } catch (err) {
            console.error('è‡ªåŠ¨ä¿å­˜å†™å…¥å¤±è´¥:', err);
            const status = document.getElementById('autosave-status');
            status.textContent = "â— ä¿å­˜å¤±è´¥";
            status.style.color = "red";
        }
    }

    // --- æ–°å¢ï¼šåŠ è½½å¯¹è¯åŠŸèƒ½ ---
    function handleFileImport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedHistory = JSON.parse(e.target.result);
                
                if (!Array.isArray(loadedHistory)) {
                    throw new Error("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šå†…å®¹ä¸æ˜¯æ•°ç»„");
                }

                // 1. æ¸…ç©ºå½“å‰ç•Œé¢
                chatContainer.innerHTML = '';
                messageHistory = [];

                // 2. éå†å¹¶æ¸²æŸ“æ¶ˆæ¯
                loadedHistory.forEach(msg => {
                    if (!msg.role || !msg.content) return;
                    
                    messageHistory.push(msg);
                    
                    let contentHtml = "";
                    if (msg.role === 'assistant') {
                        // AI æ¶ˆæ¯éœ€è¦ Markdown è§£æ
                        contentHtml = marked.parse(msg.content);
                    } else {
                        // ç”¨æˆ·æ¶ˆæ¯é€šå¸¸æ˜¯çº¯æ–‡æœ¬ï¼Œä½†ä¹Ÿå¯èƒ½åŒ…å« LaTeX
                        // ç®€å•è½¬ä¹‰ HTML æ ‡ç­¾é˜²æ­¢ XSSï¼Œä½†ä¿ç•™ LaTeX ç¬¦å·
                        contentHtml = msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    }
                    
                    appendMessage(msg.role === 'assistant' ? 'ai' : 'user', contentHtml);
                });

                // 3. é‡æ–°æ¸²æŸ“æ‰€æœ‰æ•°å­¦å…¬å¼
                MathJax.typesetPromise([chatContainer]).then(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });

                // 4. å¦‚æœå¼€å¯äº†è‡ªåŠ¨ä¿å­˜ï¼Œç«‹å³å°†åŠ è½½çš„å†…å®¹å†™å…¥å½“å‰è‡ªåŠ¨ä¿å­˜æ–‡ä»¶
                if (isAutoSaveActive) {
                    writeToFile();
                }

                alert(`æˆåŠŸåŠ è½½ ${loadedHistory.length} æ¡æ¶ˆæ¯`);
                
                // å…³é—­è®¾ç½®é¢æ¿
                const panel = document.getElementById('settings-panel');
                if(panel.style.display === 'flex') toggleSettings();

            } catch (err) {
                alert("åŠ è½½å¤±è´¥: " + err.message);
            }
        };
        reader.readAsText(file);
        input.value = ''; // é‡ç½® inputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
    }

    function exportChat() {
        if (messageHistory.length === 0) {
            alert('æš‚æ— å¯¹è¯è®°å½•å¯å¯¼å‡º');
            return;
        }
        const dataStr = JSON.stringify(messageHistory, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const date = new Date();
        const timestamp = date.toISOString().slice(0,19).replace(/[-T:]/g,"");
        a.download = `math_chat_export_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function fetchAndShowModels(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('model-dropdown');
        const apiKey = document.getElementById('api-key').value.trim();
        let apiUrl = document.getElementById('api-url').value.trim() || defaultUrl;

        if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
            return;
        }

        if (!apiKey) {
            alert('è¯·å…ˆå¡«å†™ API Key');
            return;
        }

        dropdown.classList.add('show');
        dropdown.innerHTML = '<div class="model-option loading">æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</div>';

        try {
            if (apiUrl.endsWith('/chat/completions')) {
                apiUrl = apiUrl.replace('/chat/completions', '');
            }
            if (apiUrl.endsWith('/')) {
                apiUrl = apiUrl.slice(0, -1);
            }
            const modelsUrl = `${apiUrl}/models`;

            const response = await fetch(modelsUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.json();
            const models = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
            models.sort((a, b) => a.id.localeCompare(b.id));

            dropdown.innerHTML = '';

            if (models.length === 0) {
                dropdown.innerHTML = '<div class="model-option error">æœªæ‰¾åˆ°æ¨¡å‹</div>';
                return;
            }

            models.forEach(model => {
                const div = document.createElement('div');
                div.className = 'model-option';
                div.textContent = model.id;
                div.onclick = () => {
                    document.getElementById('model-name').value = model.id;
                    dropdown.classList.remove('show');
                };
                dropdown.appendChild(div);
            });

        } catch (error) {
            dropdown.innerHTML = `<div class="model-option error">è·å–å¤±è´¥: ${error.message}<br>è¯·æ£€æŸ¥ URL å’Œ Key</div>`;
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    let renderPromise = Promise.resolve();

    const updatePreview = debounce(function() {
        const text = userInput.value;
        if (!text.trim()) {
            previewArea.classList.remove('show');
            return;
        }
        previewArea.classList.add('show');
        previewArea.innerHTML = marked.parse(text);
        renderPromise = renderPromise.then(() => {
            return MathJax.typesetPromise([previewArea]);
        }).catch((err) => {
            console.log('MathJax render error: ', err);
        });

    }, 300);

    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = '44px';
        updatePreview();
    });

    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const text = userInput.value.trim();
        const apiKey = document.getElementById('api-key').value.trim();
        let apiUrl = document.getElementById('api-url').value.trim() || defaultUrl;
        const model = document.getElementById('model-name').value.trim() || defaultModel;

        if (!text) return;
        if (!apiKey) { alert('è¯·ç‚¹å‡»é¡¶éƒ¨è®¾ç½®å¡«å†™ API Key'); toggleSettings(); return; }

        if (apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
        if (!apiUrl.endsWith('/chat/completions')) apiUrl += '/chat/completions';

        appendMessage('user', text); // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬ï¼ŒappendMessage å†…éƒ¨ä¼šå¤„ç†
        
        userInput.value = '';
        userInput.style.height = '44px';
        previewArea.classList.remove('show');
        previewArea.innerHTML = '';
        
        messageHistory.push({ role: "user", content: text });
        
        await writeToFile();

        const aiMessageDiv = appendMessage('ai', '<span class="typing">æ€è€ƒä¸­...</span>');
        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;

        let fullText = "";

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: messageHistory, stream: true })
            });

            if (!response.ok) throw new Error((await response.json()).error?.message || 'è¯·æ±‚å¤±è´¥');

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            aiMessageDiv.innerHTML = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6);
                        if (jsonStr === '[DONE]') break;
                        try {
                            const content = JSON.parse(jsonStr).choices[0]?.delta?.content || "";
                            fullText += content;
                            aiMessageDiv.innerText = fullText;
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        } catch (e) {}
                    }
                }
            }

            messageHistory.push({ role: "assistant", content: fullText });
            
            await writeToFile();

            aiMessageDiv.innerHTML = marked.parse(fullText);
            MathJax.typesetPromise([aiMessageDiv]).then(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });

        } catch (error) {
            aiMessageDiv.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
        } finally {
            sendBtn.disabled = false;
        }
    }

    function appendMessage(role, html) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerHTML = html;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        // ä»…å¯¹ç”¨æˆ·æ¶ˆæ¯è¿›è¡Œ MathJax æ¸²æŸ“ï¼ˆAI æ¶ˆæ¯åœ¨æµå¼ä¼ è¾“ç»“æŸåç»Ÿä¸€æ¸²æŸ“ï¼‰
        if (role === 'user') {
             MathJax.typesetPromise([div]);
        }
        return div;
    }
</script>

</body>
</html>
